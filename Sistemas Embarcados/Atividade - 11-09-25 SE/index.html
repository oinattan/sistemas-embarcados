<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lista de Scripts Python - Sistemas Embarcados</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 30px; }
        .script-list { list-style: none; padding: 0; }
        .script-list li { margin-bottom: 10px; }
        button { margin-left: 10px; }
        #output { margin-top: 30px; padding: 10px; border: 1px solid #ccc; min-height: 100px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Scripts de Sistemas Embarcados</h1>
    <ul id="scripts" class="script-list">
        <li>Carregando lista...</li>
    </ul>
    <div id="output">Selecione um script para executar.</div>
    <div id="status" style="margin-top:10px;color:#666"></div>

    <script>
        async function loadScripts(){
            const statusEl = document.getElementById('status');
            try{
                const health = await fetch('/health');
                if(health.ok){
                    const h = await health.json();
                    statusEl.textContent = 'Servidor: ' + (h.status || 'ok');
                }else{
                    statusEl.textContent = 'Servidor indisponível (health check falhou)';
                }
            }catch(e){
                statusEl.textContent = 'Servidor indisponível (erro de conexão)';
            }

            const res = await fetch('/scripts');
            const ul = document.getElementById('scripts');
            if(!res.ok){
                const text = await res.text().catch(()=>res.statusText);
                ul.innerHTML = `<li>Erro ao carregar scripts: ${res.status} ${text}</li>`;
                return;
            }
            const list = await res.json();
            ul.innerHTML = '';
            list.forEach(name => {
                const li = document.createElement('li');
                li.textContent = name;
                const btn = document.createElement('button');
                btn.textContent = 'Executar';
                btn.onclick = () => runScript(name);
                li.appendChild(btn);
                ul.appendChild(li);
            });
        }

        async function runScript(name){
            const output = document.getElementById('output');
            output.textContent = `Executando ${name}...`;
            try{
                const res = await fetch('/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({script: name})
                });
                let data;
                try{ data = await res.json(); }catch(e){ data = null }
                if(!res.ok){
                    const bodyText = data ? JSON.stringify(data) : await res.text().catch(()=>res.statusText);
                    output.textContent = `Erro HTTP ${res.status}: ${bodyText}`;
                    return;
                }
                output.textContent = `Return code: ${data.returncode}\n\nSTDOUT:\n${data.stdout || ''}\n\nSTDERR:\n${data.stderr || ''}`;
            }catch(e){
                output.textContent = 'Erro de conexão: '+e.message + '\nVerifique se o servidor Flask está rodando e abra esta página via http://127.0.0.1:5000/ (não pelo file://)';
            }
        }

        loadScripts();
    </script>
</body>
</html>
